# GNSS 定位模块在 AT89C52RC 上的数据传输与显示——项目说明文档

## 一、项目背景与目标

本项目是大三下学期电子信息工程设计实践课程的课设项目。

**目标：** 利用 AT89C52 单片机通过 UART 串口接收 GNSS（北斗/GPS）定位模块输出的 NMEA 标准协议数据，对其进行解析，提取出经纬度、时间等定位信息，最终实时显示在 LCD1602 液晶屏上。

---

## 二、硬件平台

| 模块 | 型号/说明 |
|------|-----------|
| MCU | AT89C52 / AT89C52RC（8051内核） |
| GNSS 定位模块 | HT2828Z3G5L（参考资料为大夏龙雀 DX-GP10，引脚定义略有差异） |
| 显示模块 | LCD1602 液晶屏（16列×2行） |
| 调试工具 | GNssToolKit3（PC端串口可视化工具，验证模块输出） |
| 状态指示 | P2.0（定位状态LED）、P2.1（数据接收LED） |

**硬件连接：**
- GNSS 模块 TX → 单片机 RXD（P3.0），波特率 9600bps，晶振 11.0592MHz
- LCD1602 数据总线接 P0 口
- LCD1602 控制引脚：RS → P2.6，RW → P2.5，EN → P2.7

---

## 三、串口通信配置（各版本共用）

```c
TMOD |= 0x20;   // 定时器1，模式2（8位自动重装）
TH1 = TL1 = 0xFD;  // 波特率 9600bps @ 11.0592MHz
SCON = 0x50;    // 串口模式1，允许接收
TR1 = 1;        // 启动定时器1
EA = 1; ES = 1; // 开全局中断 & 串口中断
```

---

## 四、NMEA 协议说明

GNSS 模块输出标准 NMEA 0183 格式数据，每条语句以 `$` 开头、`\r\n` 结尾，字段间用逗号 `,` 分隔。

| 语句类型 | 含义 |
|----------|------|
| `$GPRMC` | GPS 推荐最小定位信息，含时间、有效性、经纬度、速度、方向角 |
| `$GNRMC` | 多系统（北斗+GPS）推荐最小定位信息 |
| `$GPGGA` | GPS 定位详情，含高度、卫星数、HDOP |
| `$GNGGA` | 多系统定位详情 |
| `$GNGLL` | 多系统地理位置（纬度/经度） |

**`$GPRMC` 典型格式：**
```
$GPRMC,时间,状态,纬度,N/S,经度,E/W,速度,方向,日期,磁偏角,...*校验
```
字段序号：1=时间, 2=状态(A有效/V无效), 3=纬度, 4=N/S, 5=经度, 6=E/W

---

## 五、各版本开发流程与说明

### 版本一：`666/` —— 原始串口调试版（最早期）

**我做了什么：**
- 直接用串口中断将 GNSS 模块输出的所有数据原始接收到 `idata` 80字节缓冲区中
- 支持识别 `$GPGGA`、`$GNGGA`、`$GPRMC` 三种语句
- 实现了完整的通用解析函数 `GPS_Parse()`，能提取纬度（整数+4位小数）、经度（整数+4位小数）、N/S、E/W、定位状态
- **调试模式：** 上电后先在 LCD 上直接显示接收到的原始 NMEA 字符串（前32字节），便于验证模块是否正常输出
- **正常模式：** 收到有效数据后自动切换，LCD 第一行显示 `Lat:XX.XXXXN`，第二行显示 `Lon:XXX.XXXXE`
- 增加了诊断统计功能：记录并显示接收字节总数（Rx）、GGA 帧计数、其他帧计数、当前定位状态字符
- 使用 P2.0、P2.1 两个 LED 分别指示定位状态和数据接收活动
- 超过一定时间未收到有效数据时自动回退到原始数据显示模式

**关键技术点：**
- 缓冲区存放在 `idata`（内部 RAM 高128字节），节省 DATA 区空间
- 小数部分以 `unsigned int`（0-9999 四位）存储，显示时拼接整数+小数

---

### 版本二：`analyse/` —— 状态机解析版

**我做了什么：**
- 用状态机（`RX_count` 变量）在串口中断中逐字节直接解析 `$GNRMC` 语句，无需存储完整缓冲区
- 串口中断 ISR 中按状态逐步匹配：`$ → G → N → R → M → C → ,`，随后跳过时间和状态字段，按位提取纬度数字（5位）、N/S 方向、经度数字（4位）、E/W 方向
- 定义 `GPS_INFO` 结构体，将经纬度各位数字单独存为 `unsigned char` 数组，NS/EW 存为字符
- 预设初始值（湖南坐标附近），方便上电后调试时 LCD 立即有显示
- 主循环轮询刷新 LCD：逐字显示经度/纬度各位数字和方向字母
- 额外引入了 `FONT.h`、`LCD1602.h`、`Delay.h` 等封装模块

**关键技术点：**
- 状态机方式解析无需额外内存缓冲，直接在中断中处理，适合 RAM 极小的 8051
- 经纬度数字以各位分开存储（`'0'~'9'` 减去 `'0'` 存为数值），LCD 按位 `+48` 还原显示

---

### 版本三：`project/` —— ChatGPT 优化版（未验证运行）

**我做了什么：**
- 将串口接收改为 256 字节循环缓冲区（存放在 `xdata`），中断只负责写入，主循环读取
- 实现 `GPS_GetSentence()` 函数：轮询 `uart_getchar()` 读取环形缓冲，拼出完整 NMEA 句子（`$` 开头，`\n` 结尾）
- 实现 `GPS_ParseGPRMC()` 函数：用 `strtok()` 按逗号分割字段，提取第3字段（纬度字符串）、第4字段（N/S）、第5字段（经度字符串）、第6字段（E/W）
- `GPS_Data_t` 结构体中纬度/经度以完整字符串存储（如 `"2428.1234"`）
- LCD 第0行显示纬度字符串，第1行显示经度字符串

**存在的问题：**
- 该版本引入了 `strtok()`，在 Keil C51 中会与 `xdata` 缓冲区配合产生问题（C51 的 `strtok` 实现有限制）
- 编译或运行中存在未解决的问题，**实际未能在硬件上跑通**，仅作为探索参考

---

### 版本四：`new/` —— 中断驱动精简版（最新推荐）

**我做了什么：**
- 重新设计为最简洁的中断驱动架构，40 字节静态缓冲区
- 串口中断 ISR：收到 `$` 时重置索引，收到 `\r` 或 `\n` 时置全局标志位 `gpsDataReady = 1`
- 主函数轮询 `gpsDataReady`，调用 `GPS_GetParsedData()` 解析 `$GNGLL` 语句
- 解析逻辑：遍历 `buffer`，按逗号计数字段，field=1,2 拼纬度，field=3,4 拼经度，到 `*` 停止
- `GpsData_t` 结构体存储 `lat[]`（纬度字符串）和 `lon[]`（经度字符串）
- LCD 第0行显示 `Lat:XXXX`，第1行显示 `Lon:XXXX`
- 引入独立模块：`Delay.c/h`、`LCD1602.c/h`、`gps_module.c/h`，结构清晰，便于维护

**关键技术点：**
- 选择 `$GNGLL` 而非 `$GPRMC`，因为测试时该模块 `$GNGLL` 输出更稳定
- 将缓冲区设为 40 字节（`$GNGLL` 句子长度约 35-40 字节），避免 RAM 浪费
- `gpsDataReady` 声明为 `volatile bit`，确保中断与主循环间通信安全

---

## 六、实验过程回顾

1. **硬件验证：** 先将 GNSS 模块通过 USB-串口适配器连接 PC，用 GNssToolKit3 软件确认模块能正常输出位置数据（时间、经纬度可见）
2. **原始数据验证：** 用 PC 串口助手（波特率 9600）查看模块输出的原始 NMEA 语句，确认语句格式
3. **在单片机调试：** 先跑 `666/` 版本，LCD 上显示原始 NMEA 字节，确认串口通路正确
4. **功能迭代：** 逐步从原始显示 → 状态机解析(`analyse/`) → 字符串解析尝试(`project/`) → 中断驱动精简版(`new/`)
5. **参考资料：** 参考了 B 站博主"缘不负卿"的 C51 GPS 仿真程序 [BV1hB4y1S7JS](https://www.bilibili.com/video/BV1hB4y1S7JS/?share_source=copy_web&vd_source=318d317c1404fb1dfeb57deb06f23b93)

---

## 七、实验过程图片

![GNssToolKit3 PC端验证](https://i.postimg.cc/PxsG7Mvx/Screenshot-2025-06-26-142009.png)
*GNssToolKit3 显示经纬度与时间*

![串口助手原始数据](https://i.postimg.cc/J4hFPFYx/Screenshot-2025-06-26-100846.png)
*PC 串口助手查看 NMEA 原始输出*

![实物运行照片](https://i.postimg.cc/rpGg8GYz/20250628180124.jpg)
*单片机+LCD1602 实物运行效果*

---

## 八、遇到的主要技术难点

| 难点 | 解决方式 |
|------|----------|
| 8051 内部 RAM 只有 128 字节 | 将缓冲区放入 `xdata`（外部 RAM），结构体存 `idata` |
| NMEA 单句最长 80+ 字节 | 缩减缓冲区长度，只保留当前解析句，解析完即清空 |
| `strtok()` 在 C51 中行为异常 | 改用手动遍历逗号计数字段的方式替代 |
| 波特率不准导致乱码 | 确认晶振为精确的 11.0592MHz，`TH1=0xFD` 对应精确 9600bps |
| LCD 显示乱码 | 检查 P0 口驱动能力，确认 RS/RW/EN 时序延时足够 |
| 多帧类型筛选 | 先匹配句子类型前缀字符串后再进入对应解析逻辑 |

---

## 九、文件目录说明

```
BD_data_catch/
├── 666/          原始调试版：直接显示原始NMEA+通用解析，含诊断统计
├── analyse/      状态机版：串口中断内逐字节状态机解析$GNRMC
├── project/      ChatGPT优化版：环形缓冲区+strtok解析，未验证运行
├── new/          最新精简版：中断驱动+$GNGLL解析，推荐版本
├── C51_GPS/      B站参考仿真程序（Proteus仿真图+代码）
├── DX-GP10_resource/   大夏龙雀GNSS模块资料（参考）
├── GnssToolKit3/ GNSS模块PC端调试工具
├── Data_catch.c  早期单文件草稿
├── README.md     项目简介
└── read.md       本文档（项目详细说明）
```

---

## 十、参考资料

- 大夏龙雀 DX-GP10 模块技术手册（`DX-GP10_resource/`）
- B站"缘不负卿"：[C51 GPS仿真程序](https://www.bilibili.com/video/BV1hB4y1S7JS/?share_source=copy_web&vd_source=318d317c1404fb1dfeb57deb06f23b93)
- NMEA 0183 协议标准
- Keil C51 编译器用户手册
